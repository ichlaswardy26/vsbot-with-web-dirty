<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<div class="flex">
  <%- include('../partials/sidebar') %>
  
  <main class="flex-1 p-8">
    <div class="max-w-7xl mx-auto">
      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Dashboard Settings</h1>
        <p class="text-gray-600 mt-2">Customize your dashboard appearance and behavior</p>
      </div>

      <!-- Settings Form -->
      <form id="settingsForm" class="space-y-6">
        
        <!-- General Settings -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
          <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-cog text-purple-600 mr-2"></i>General Settings
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Dashboard Title</label>
              <input type="text" name="title" value="<%= settings.title %>" 
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Subtitle</label>
              <input type="text" name="subtitle" value="<%= settings.subtitle %>" 
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Brand Name</label>
              <input type="text" name="brandName" value="<%= settings.brandName %>" 
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Logo URL (optional)</label>
              <input type="url" name="logoUrl" value="<%= settings.logoUrl %>" 
                     placeholder="https://example.com/logo.png"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
          </div>
        </div>

        <!-- Branding -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
          <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-palette text-blue-600 mr-2"></i>Branding & Colors
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Primary Color</label>
              <div class="flex space-x-2">
                <input type="color" name="brandColor" value="<%= settings.brandColor %>" 
                       class="w-20 h-10 border border-gray-300 rounded-lg cursor-pointer">
                <input type="text" value="<%= settings.brandColor %>" readonly
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
              </div>
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Secondary Color</label>
              <div class="flex space-x-2">
                <input type="color" name="brandColorSecondary" value="<%= settings.brandColorSecondary %>" 
                       class="w-20 h-10 border border-gray-300 rounded-lg cursor-pointer">
                <input type="text" value="<%= settings.brandColorSecondary %>" readonly
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
              </div>
            </div>
          </div>
        </div>

        <!-- Footer Settings -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
          <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-shoe-prints text-green-600 mr-2"></i>Footer Settings
          </h2>
          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">Footer Text</label>
            <input type="text" name="footerText" value="<%= settings.footerText %>" 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
          </div>
        </div>

        <!-- Features -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
          <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-toggle-on text-orange-600 mr-2"></i>Features
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex items-center">
              <input type="checkbox" name="enableAuditLogs" <%= settings.enableAuditLogs ? 'checked' : '' %>
                     class="w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
              <label class="ml-3 text-gray-700 font-medium">Enable Audit Logs</label>
            </div>
            <div class="flex items-center">
              <input type="checkbox" name="enableBulkOperations" <%= settings.enableBulkOperations ? 'checked' : '' %>
                     class="w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
              <label class="ml-3 text-gray-700 font-medium">Enable Bulk Operations</label>
            </div>
            <div class="flex items-center">
              <input type="checkbox" name="enableDataExport" <%= settings.enableDataExport ? 'checked' : '' %>
                     class="w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
              <label class="ml-3 text-gray-700 font-medium">Enable Data Export</label>
            </div>
            <div class="flex items-center">
              <input type="checkbox" name="enableAnalytics" <%= settings.enableAnalytics ? 'checked' : '' %>
                     class="w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
              <label class="ml-3 text-gray-700 font-medium">Enable Analytics</label>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
          <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-list text-indigo-600 mr-2"></i>Pagination
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Users Per Page</label>
              <input type="number" name="usersPerPage" value="<%= settings.usersPerPage %>" 
                     min="10" max="100"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Levels Per Page</label>
              <input type="number" name="levelsPerPage" value="<%= settings.levelsPerPage %>" 
                     min="10" max="100"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Audit Logs Per Page</label>
              <input type="number" name="auditLogsPerPage" value="<%= settings.auditLogsPerPage %>" 
                     min="10" max="100"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
          </div>
        </div>

        <!-- Maintenance Mode -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
          <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-tools text-red-600 mr-2"></i>Maintenance Mode
          </h2>
          <div class="space-y-4">
            <div class="flex items-center">
              <input type="checkbox" name="maintenanceMode" <%= settings.maintenanceMode ? 'checked' : '' %>
                     class="w-5 h-5 text-red-600 border-gray-300 rounded focus:ring-red-500">
              <label class="ml-3 text-gray-700 font-medium">Enable Maintenance Mode</label>
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Maintenance Message</label>
              <textarea name="maintenanceMessage" rows="3"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"><%= settings.maintenanceMessage %></textarea>
            </div>
          </div>
        </div>

        <!-- Security -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
          <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-shield-alt text-yellow-600 mr-2"></i>Security
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Session Timeout (days)</label>
              <input type="number" name="sessionTimeout" value="<%= settings.sessionTimeout %>" 
                     min="1" max="30"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Max Login Attempts</label>
              <input type="number" name="maxLoginAttempts" value="<%= settings.maxLoginAttempts %>" 
                     min="3" max="10"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between">
          <button type="button" onclick="resetSettings()" 
                  class="bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition">
            <i class="fas fa-undo mr-2"></i>Reset to Default
          </button>
          <button type="submit" 
                  class="bg-purple-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-purple-700 transition">
            <i class="fas fa-save mr-2"></i>Save Settings
          </button>
        </div>
      </form>
    </div>
  </main>
</div>

<script>
  document.getElementById('settingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const settings = {};
    
    // Convert form data to object
    for (let [key, value] of formData.entries()) {
      // Handle checkboxes
      if (e.target.elements[key].type === 'checkbox') {
        settings[key] = e.target.elements[key].checked;
      }
      // Handle numbers
      else if (e.target.elements[key].type === 'number') {
        settings[key] = parseInt(value);
      }
      // Handle text
      else {
        settings[key] = value;
      }
    }
    
    // Handle unchecked checkboxes
    const checkboxes = e.target.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      if (!checkbox.checked) {
        settings[checkbox.name] = false;
      }
    });

    try {
      const response = await fetch('/dashboard/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(settings)
      });

      const result = await response.json();

      if (result.success) {
        alert('✅ Settings saved successfully! Refresh the page to see changes.');
      } else {
        alert('❌ Failed to save settings: ' + result.error);
      }
    } catch (error) {
      alert('❌ Error: ' + error.message);
    }
  });

  async function resetSettings() {
    if (!confirm('Are you sure you want to reset all settings to default? This cannot be undone.')) {
      return;
    }

    try {
      const response = await fetch('/dashboard/settings/reset', {
        method: 'POST'
      });

      const result = await response.json();

      if (result.success) {
        alert('✅ Settings reset to default! Refreshing page...');
        location.reload();
      } else {
        alert('❌ Failed to reset settings: ' + result.error);
      }
    } catch (error) {
      alert('❌ Error: ' + error.message);
    }
  }

  // Update color preview
  document.querySelectorAll('input[type="color"]').forEach(input => {
    input.addEventListener('change', (e) => {
      const textInput = e.target.nextElementSibling;
      if (textInput) {
        textInput.value = e.target.value;
      }
    });
  });
</script>

<%- include('../partials/footer') %>
