<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<div class="flex">
  <%- include('../partials/sidebar') %>
  
  <main class="flex-1 p-8">
    <div class="max-w-7xl mx-auto">
      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Audit Logs</h1>
        <p class="text-gray-600 mt-2">Track all administrative actions</p>
      </div>

      <!-- Filters -->
      <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Filters</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">Action</label>
            <select id="filterAction" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
              <option value="">All Actions</option>
              <option value="USER_UPDATE">User Update</option>
              <option value="USER_DELETE">User Delete</option>
              <option value="LEVEL_UPDATE">Level Update</option>
              <option value="CONFIG_UPDATE">Config Update</option>
              <option value="BULK_OPERATION">Bulk Operation</option>
              <option value="DATA_EXPORT">Data Export</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">Start Date</label>
            <input type="date" id="filterStartDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
          </div>
          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">End Date</label>
            <input type="date" id="filterEndDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
          </div>
          <div class="flex items-end">
            <button onclick="applyFilters()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
              <i class="fas fa-filter mr-2"></i>Apply Filters
            </button>
          </div>
        </div>
      </div>

      <!-- Audit Logs Table -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admin</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Target</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changes</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
              </tr>
            </thead>
            <tbody id="logsTableBody" class="bg-white divide-y divide-gray-200">
              <tr>
                <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                  <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pagination -->
      <div id="pagination" class="mt-6 flex justify-center">
        <!-- Pagination will be inserted here -->
      </div>
    </div>
  </main>
</div>

<script>
  let currentPage = 1;
  let currentFilters = {};

  async function loadLogs(page = 1) {
    try {
      const params = new URLSearchParams({
        page,
        limit: 50,
        ...currentFilters
      });

      const response = await fetch(`/api/advanced/audit-logs?${params}`);
      const result = await response.json();

      if (result.success) {
        displayLogs(result.data);
        displayPagination(result.pagination);
      } else {
        alert('Failed to load audit logs');
      }
    } catch (error) {
      console.error('Error loading logs:', error);
      alert('Error loading audit logs');
    }
  }

  function displayLogs(logs) {
    const tbody = document.getElementById('logsTableBody');
    
    if (logs.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="px-6 py-4 text-center text-gray-500">
            No audit logs found
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = logs.map(log => {
      const actionColor = getActionColor(log.action);
      const timestamp = new Date(log.createdAt).toLocaleString();
      const changes = formatChanges(log);

      return `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            ${timestamp}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            ${log.adminUsername}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 text-xs font-semibold rounded-full ${actionColor}">
              ${log.action.replace(/_/g, ' ')}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            ${log.targetId || '-'}
          </td>
          <td class="px-6 py-4 text-sm text-gray-900">
            ${changes}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${log.ipAddress || '-'}
          </td>
        </tr>
      `;
    }).join('');
  }

  function getActionColor(action) {
    const colors = {
      'USER_UPDATE': 'bg-blue-100 text-blue-800',
      'USER_DELETE': 'bg-red-100 text-red-800',
      'LEVEL_UPDATE': 'bg-green-100 text-green-800',
      'CONFIG_UPDATE': 'bg-yellow-100 text-yellow-800',
      'BULK_OPERATION': 'bg-purple-100 text-purple-800',
      'DATA_EXPORT': 'bg-indigo-100 text-indigo-800'
    };
    return colors[action] || 'bg-gray-100 text-gray-800';
  }

  function formatChanges(log) {
    if (log.oldValues && log.newValues) {
      const changes = [];
      for (const key in log.newValues) {
        if (log.oldValues[key] !== log.newValues[key]) {
          changes.push(`${key}: ${log.oldValues[key]} â†’ ${log.newValues[key]}`);
        }
      }
      return changes.join('<br>') || 'No changes';
    }
    if (log.changes) {
      return JSON.stringify(log.changes);
    }
    return '-';
  }

  function displayPagination(pagination) {
    const paginationDiv = document.getElementById('pagination');
    
    if (pagination.pages <= 1) {
      paginationDiv.innerHTML = '';
      return;
    }

    let html = '<nav class="flex space-x-2">';
    
    for (let i = 1; i <= pagination.pages; i++) {
      const active = i === pagination.page ? 'bg-purple-600 text-white' : 'bg-white text-gray-700';
      html += `
        <button onclick="loadLogs(${i})" 
                class="px-4 py-2 ${active} rounded-lg border border-gray-300 hover:bg-purple-100">
          ${i}
        </button>
      `;
    }
    
    html += '</nav>';
    paginationDiv.innerHTML = html;
  }

  function applyFilters() {
    currentFilters = {};
    
    const action = document.getElementById('filterAction').value;
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    
    if (action) currentFilters.action = action;
    if (startDate) currentFilters.startDate = startDate;
    if (endDate) currentFilters.endDate = endDate;
    
    loadLogs(1);
  }

  // Load logs on page load
  loadLogs();
</script>

<%- include('../partials/footer') %>
